<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monitoreo GPS WebApp Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #fff; }
    .container { max-width: 960px; margin: 0 auto; padding: 10px; }
    h1 { font-size: 1.6em; text-align: center; margin: 10px 0 4px; }
    h2 { font-size: 1em; text-align: center; margin: 0 0 10px; }
    form { display: flex; flex-direction: column; gap: 10px; }
    .form-row { display: flex; flex-wrap: wrap; gap: 10px; }
    .form-group { flex: 1; display: flex; flex-direction: column; min-width: 140px; }
    .form-group.full-width { flex: 100%; }
    label { font-size: 0.9em; margin: 6px 0 4px; }
    input, select, textarea, button {
      font-size: 1em; padding: 6px; border: 1px solid #ccc;
      border-radius: 4px; width: 100%; box-sizing: border-box;
    }
    button { background-color: #007BFF; color: white; border: none; }
    button:hover { background-color: #0056b3; }
    textarea { resize: vertical; min-height: 60px; }
    .divider { display: flex; align-items: center; text-align: center; margin: 15px 0 5px; }
    .divider::before, .divider::after {
      content: ""; flex: 1; border-bottom: 1px solid #ccc;
    }
    .divider:not(:empty)::before { margin-right: .5em; }
    .divider:not(:empty)::after { margin-left: .5em; }
    .hidden { display: none; }
    #map { height: 300px; margin-top: 10px; }
    #progressBar { width: 100%; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 10px; }
    #progressBarFill {
      height: 20px; width: 0%; background: green;
      color: white; text-align: center; line-height: 20px;
    }
    .log {
      font-size: 0.9em; white-space: pre-wrap;
      margin-top: 10px; background: #f4f4f4;
      padding: 10px; border-radius: 4px;
    }
    @media (max-width: 768px) {
      .form-row { flex-direction: row; flex-wrap: wrap; }
      .form-group { flex: 0 0 48%; }
      .form-group.full-width { flex: 0 0 100%; }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="formScreen">
    <h1>Monitoreo de posici√≥n GPS</h1>
    <h2>Prototipo elaborado por Carlos Aliaga</h2>
    <p style="text-align: center; font-size: 0.6em; margin: 0 10px 10px;">
      Este prototipo (formulario 31) permite recibir durante 10 minutos la informaci√≥n de la posici√≥n del celular del conductor.
      El conductor remite voluntariamente esta informaci√≥n a fin de que se monitoree su recorrido y declara que
      la informaci√≥n enviada y la informaci√≥n monitoreada tiene car√°cter p√∫blico.
    </p>
    <form id="gpsForm">
      <div class="form-row">
        <div class="form-group placa-group">
          <label for="placa">Placa</label>
          <input type="text" id="placa" name="placa" required />
        </div>
        <div class="form-group boton-group">
          <label>&nbsp;</label>
          <button type="button" onclick="toggleOpcionales()">Mostrar campos opcionales</button>
        </div>
      </div>
      <div id="opcionalFields" class="hidden">
        <div class="divider">Datos opcionales del conductor</div>
        <div class="form-row">
          <div class="form-group"><label for="nombres">Nombres</label><input type="text" id="nombres" name="nombres" /></div>
          <div class="form-group"><label for="apellidos">Apellidos</label><input type="text" id="apellidos" name="apellidos" /></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="dni">DNI</label><input type="text" inputmode="numeric" pattern="\d*" id="dni" name="dni" /></div>
          <div class="form-group"><label for="celular">Celular</label><input type="tel" id="celular" name="celular" /></div>
        </div>
        <div class="divider">Otros datos opcionales</div>
        <div class="form-row">
          <div class="form-group full-width">
            <label for="carga">Tipo de carga transportada</label>
            <select id="carga" name="carga">
              <option value="">Seleccione una opci√≥n</option>
              <option value="Contenedor">Contenedor</option>
              <option value="Fraccionada">Fraccionada</option>
              <option value="Granel s√≥lido">Granel s√≥lido</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label for="comentarios">Comentarios</label>
            <textarea id="comentarios" name="comentarios"></textarea>
          </div>
        </div>
      </div>
      <button type="submit">Iniciar monitoreo</button>
    </form>
    <div id="map" class="hidden"></div>
    <div id="progressBar" class="hidden"><div id="progressBarFill">0%</div></div>
    <div id="log" class="log hidden"></div>
  </div>
</div>

<script>
const form = document.getElementById('gpsForm');
const opcionalFields = document.getElementById('opcionalFields');
const logDiv = document.getElementById('log');
const mapDiv = document.getElementById('map');
const progressBar = document.getElementById('progressBar');
const progressBarFill = document.getElementById('progressBarFill');
let map, marker;
let wakeLock = null;

// ‚úÖ Token de tu bot
const TELEGRAM_BOT_TOKEN = '7463888349:AAFmUXjfbygCUGi0ibwmtfDJ1mnQLYTS2rY';

// ‚úÖ Detectar el ID del usuario desde Telegram WebApp
Telegram.WebApp.ready();
const user_id = Telegram.WebApp.initDataUnsafe?.user?.id || null;

function toggleOpcionales() {
  opcionalFields.classList.toggle('hidden');
}

async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', () => console.log('Wake Lock liberado'));
      console.log('Wake Lock activo');
    }
  } catch (err) {
    console.error('Error al solicitar Wake Lock:', err);
  }
}

function sendToTelegram(payload) {
  if (!user_id) return;
  const msg = `
üöö *Monitoreo GPS*
üïí ${new Date(payload.timestamp).toLocaleTimeString()}
üìç *Placa:* ${payload.placa}
üìç Lat: ${payload.lat.toFixed(5)}, Lon: ${payload.lon.toFixed(5)}
üéØ Precisi√≥n: ¬±${payload.accuracy}m
üë§ ${payload.nombres || ''} ${payload.apellidos || ''}
üì± *Celular:* ${payload.celular || ''}
üì¶ ${payload.carga || ''} ${payload.comentarios ? '\nüí¨ ' + payload.comentarios : ''}
  `;
  fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      chat_id: '-1002761244000',
      text: msg,
      parse_mode: 'Markdown'
    })
  });
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form).entries());
  form.classList.add('hidden');
  mapDiv.classList.remove('hidden');
  logDiv.classList.remove('hidden');
  progressBar.classList.remove('hidden');

  await requestWakeLock();

  map = L.map('map').setView([-12.0464, -77.0428], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  let count = 0;
  const total = 10;
  const interval = 60000;

  const updateProgress = () => {
    const percent = Math.round(((count + 1) / total) * 100);
    progressBarFill.style.width = percent + '%';
    progressBarFill.textContent = percent + '%';
  };

  const trackPosition = () => {
    if (count >= total) {
      wakeLock?.release();
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const coords = pos.coords;
        const payload = {
          ...data,
          timestamp: new Date().toISOString(),
          lat: coords.latitude,
          lon: coords.longitude,
          accuracy: coords.accuracy
        };
        sendToTelegram(payload);
        const msg = `[${new Date().toLocaleTimeString()}] Lat: ${coords.latitude.toFixed(5)}, Lon: ${coords.longitude.toFixed(5)}, ¬±${coords.accuracy}m`;
        logDiv.textContent += msg + '\n';

        if (!marker) {
          marker = L.marker([coords.latitude, coords.longitude]).addTo(map);
        } else {
          marker.setLatLng([coords.latitude, coords.longitude]);
        }
        map.setView([coords.latitude, coords.longitude], 15);

        updateProgress();
        count++;
        if (count < total) setTimeout(trackPosition, interval);
      },
      (err) => {
        logDiv.textContent += `[${new Date().toLocaleTimeString()}] Error: ${err.message}\n`;
        if (count < total) setTimeout(trackPosition, interval);
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  };

  trackPosition();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Formulario 27 – Monitoreo GPS + Telegram</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f2f2f2; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 1em; padding: 1em; background: white; }
    form textarea { grid-column: 1 / -1; }
    button, input, select, textarea { font-size: 1em; padding: 0.5em; }
    #monitor { display: none; padding: 1em; }
    #map { height: 200px; margin-top: 1em; }
    #log { background: #fff; padding: 1em; margin-top: 1em; max-height: 200px; overflow-y: auto; font-size: 0.9em; }
    #progress { height: 10px; background: #ccc; margin-top: 1em; }
    #progress-bar { height: 100%; width: 0%; background: #4caf50; }
  </style>
</head>
<body>
  <form id="data-form">
    <input name="placa" placeholder="Placa del vehículo" required>
    <input name="conductor" placeholder="Nombre del conductor" required>
    <select name="tipo">
      <option value="">Tipo de carga (opcional)</option>
      <option value="Refrigerado">Refrigerado</option>
      <option value="Seco">Seco</option>
      <option value="Peligroso">Peligroso</option>
    </select>
    <textarea name="comentarios" placeholder="Comentarios (opcional)"></textarea>
    <button type="submit">Iniciar monitoreo</button>
  </form>

  <div id="monitor">
    <strong>Monitoreando ubicación por 10 minutos...</strong>
    <div id="progress"><div id="progress-bar"></div></div>
    <div id="map"></div>
    <div id="log"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const telegramToken = "TU_TOKEN_AQUÍ";
    const chatId = "7289061130";

    let map, marker, watchId, wakeLock, intervalId;
    let count = 0;
    const maxCount = 10;

    const form = document.getElementById("data-form");
    const monitor = document.getElementById("monitor");
    const progressBar = document.getElementById("progress-bar");
    const logDiv = document.getElementById("log");

    function log(text) {
      const time = new Date().toLocaleTimeString();
      const div = document.createElement("div");
      div.textContent = `[${time}] ${text}`;
      logDiv.prepend(div);
    }

    function updateMap(lat, lng) {
      if (!map) {
        map = L.map("map").setView([lat, lng], 16);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        marker = L.marker([lat, lng]).addTo(map);
      } else {
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng]);
      }
    }

    async function requestWakeLock() {
      try {
        wakeLock = await navigator.wakeLock.request("screen");
        wakeLock.addEventListener("release", () => log("Wake Lock liberado"));
        log("Wake Lock activo");
      } catch (err) {
        log("No se pudo activar Wake Lock");
      }
    }

    function sendToTelegram(data) {
      const mensaje = `
📍 *Registro de ubicación*
🚚 Placa: ${data.placa}
👤 Conductor: ${data.conductor}
🕒 ${data.timestamp}
📌 Lat: ${data.lat.toFixed(6)}, Lng: ${data.lng.toFixed(6)}
🎯 Precisión: ±${data.accuracy}m
📝 ${data.comentarios || "Sin comentarios"}
      `;
      fetch(`https://api.telegram.org/bot${telegramToken}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: chatId, text: mensaje, parse_mode: "Markdown" })
      }).then(r => log("Enviado a Telegram")).catch(e => log("Error Telegram"));
    }

    async function startMonitoring(data) {
      requestWakeLock();
      monitor.style.display = "block";
      form.style.display = "none";
      count = 0;

      const sendPosition = () => {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const accuracy = pos.coords.accuracy;
          const timestamp = new Date().toLocaleString();
          updateMap(lat, lng);
          log(`Envío ${count + 1}: ${lat.toFixed(5)}, ${lng.toFixed(5)} ±${accuracy}m`);
          sendToTelegram({ ...data, lat, lng, accuracy, timestamp });
        }, err => {
          log("Error obteniendo ubicación");
        }, { enableHighAccuracy: true });
        count++;
        progressBar.style.width = `${(count / maxCount) * 100}%`;
        if (count >= maxCount) {
          clearInterval(intervalId);
          wakeLock?.release();
          log("Monitoreo completado");
        }
      };

      sendPosition();
      intervalId = setInterval(sendPosition, 60000);
    }

    form.addEventListener("submit", e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form));
      startMonitoring(data);
    });

    // Optional: register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
